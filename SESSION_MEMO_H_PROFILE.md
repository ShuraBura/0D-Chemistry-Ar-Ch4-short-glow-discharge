# Session Memo: Using Experimental nH(x) Profile

**Date**: 2025-10-30
**Branch**: `claude/handle-long-prompt-011CUZrMRefAWBuCBBKZuEbw`
**Status**: ⚠️ PENDING - Awaiting experimental data file

---

## What Was Discussed

User asked: **"We have an experimental profile of nH(x). I wonder how we can use it to define the fixed diffused H density."**

### Key Points:
1. User has spatial H density profile nH(x) measured over 0-1 mm from cathode
2. Need to map 1-D profile to single value for 0-D model
3. Two main approaches discussed:
   - **Option A**: Use spatial average as initial condition, let H evolve (validates H chemistry)
   - **Option B**: Fix H at experimental value, focus on validating CH/C₂ chemistry

---

## What Was Created (ALL COMMITTED & PUSHED)

### 1. Core Processing Tools

**`load_experimental_profile.py`** ✓
- Load nH(x) from CSV
- Calculate spatial average: `<nH> = (1/L) ∫ nH(x) dx`
- Estimate diffusion length from exponential decay
- Create example profiles for testing

**`process_experimental_data.py`** ✓
- **MAIN TOOL** for user's actual experimental data
- Expects file: `combined_density_matrix.csv`
- Auto-detects units (m/mm/cm, m⁻³ → cm⁻³)
- Extracts CG region (0-1 mm)
- Fits exponential decay for L_diff
- Generates plots and recommendations
- **STATUS**: Ready to run, but CSV file not found yet!

**`run_with_fixed_H.py`** ✓
- Example simulation with fixed H density
- Shows Option B implementation
- Compares CH and C₂ to targets

### 2. Documentation

**`USING_EXPERIMENTAL_H_PROFILE.md`** ✓ (11 KB)
- Comprehensive guide with 4 options
- Physical interpretation of spatial averaging
- Code examples for each approach
- FAQ section

**`H_PROFILE_QUICKSTART.md`** ✓ (4 KB)
- Quick reference guide
- Decision tree for choosing approach
- TL;DR instructions

### 3. Test Files

**`nH_profile_example.csv`** ✓
- Example Gaussian profile for testing
- Generated by `load_experimental_profile.py`

---

## THE ISSUE: Missing Data File

### User stated:
> "It is in the repository"

Referring to: **`combined_density_matrix.csv`**

Expected format:
```csv
distance_from_cathode, nH_m3
0.0000, 8.58e21
0.0002, 7.45e21
0.0004, 6.82e21
...
```

### Search Results:
```bash
# All searches came up empty:
find . -name "*.csv"              # Only found nH_profile_example.csv
git ls-files | grep csv           # Same
ls -la                            # Not in root directory
find . -iname "*matrix*"          # Nothing
find . -iname "*combined*"        # Nothing
```

### Possible Explanations:
1. File has different name than expected
2. File is in a branch that hasn't been pulled/checked out
3. File is in a subdirectory we didn't check
4. File needs to be added by user
5. User has file locally but not pushed yet

---

## NEXT SESSION TODO

### Priority 1: Locate Experimental Data File ⚠️

**ACTION**: Ask user to clarify location of experimental data

Questions to ask:
1. What is the exact filename? (Is it really `combined_density_matrix.csv`?)
2. What directory is it in?
3. Can you run: `find . -name "*density*" -o -name "*matrix*"` and share output?
4. Or: Can you share first 5-10 lines of the data?

### Priority 2: Once File is Found

**RUN**:
```bash
python3 process_experimental_data.py
```

This will output:
- **Spatial average nH**: Use in model as `set_density('H', nH_avg)`
- **Diffusion length L_diff**: Use in `define_rates_tunable.py`
- **Plots**: Visual of profile with fit
- **Recommendations**: Specific values for simulation

### Priority 3: Implement in Model

**Option A - Dynamic H (validation)**:
```python
# In run_cg_optimized.py or parameter_sweep_cg.py
set_density('H', nH_avg)  # From processed data
# Let simulation run normally
# Check if H stays near nH_avg
```

**Option B - Fixed H (pragmatic)**:
```python
# In odefun_optimized.py, add after line 111:
H_idx = self.species.index('H')
self.dydt[H_idx] = 0  # Freeze H at experimental value

# Or just run:
python3 run_with_fixed_H.py
```

### Priority 4: Validate Results

Compare simulation output to targets (EXPERIMENTAL_TARGETS.md):
- H:  8.58e15 cm⁻³ (CG region)
- CH: 4.6e8 cm⁻³
- C₂: 1.44e11 cm⁻³

**Success criteria**:
- Option A: Model maintains H within factor 2-3 of experimental
- Option B: CH and C₂ match within factor 2-5

---

## Key Concepts to Remember

### Why Spatial Average?
- **TALIF measures**: `<nH> = (1/L) ∫ nH(x) dx` (spatially averaged)
- **0-D model predicts**: `nH = constant` (uniform)
- **Therefore**: Compare model output to experimental average, NOT peak

From SPATIAL_AVERAGING_AND_H2.md:
> "0-D model predicts spatially uniform density (by definition).
> If actual profile peaks at n_peak = 1.5 × n_avg, then:
> - 0-D should match n_avg (what TALIF measures)
> - NOT n_peak (which would be higher)"

### Fixed vs Dynamic H

| Approach | H Evolves? | Validates H? | Use When |
|----------|------------|--------------|----------|
| Dynamic (Option A) | Yes | ✓ Yes | Model validation, testing chemistry |
| Fixed (Option B) | No | ✗ No | Focus on CH/C₂, H well-known |

---

## Current Experimental Targets

From EXPERIMENTAL_TARGETS.md (CG region, 0-1 mm):

```python
target_H  = 8.58e15  # cm⁻³ (spatially averaged)
target_CH = 4.6e8    # cm⁻³
target_C2 = 1.44e11  # cm⁻³

# Key ratios:
H/CH  = 1.87e7  # H dominates
C₂/CH = 313     # C₂ >> CH
```

---

## Files Ready to Use

All these are committed and ready:

```bash
# Process user's experimental data (when file is found)
python3 process_experimental_data.py

# Test with example profile
python3 load_experimental_profile.py

# Run simulation with fixed H
python3 run_with_fixed_H.py

# Read comprehensive guide
cat USING_EXPERIMENTAL_H_PROFILE.md

# Read quick reference
cat H_PROFILE_QUICKSTART.md
```

---

## Git Status

**Branch**: `claude/handle-long-prompt-011CUZrMRefAWBuCBBKZuEbw`
**Last commits**:
- `1e180ee`: Add script to process experimental nH(x) data from CSV file
- `91e84c3`: Add tools for using experimental H density profiles in 0-D model

**Status**: Clean, all changes committed and pushed ✓

---

## What to Tell User in Next Session

1. **"I created complete toolset for using your experimental nH(x) profile"**
   - 5 new files (2 Python tools, 3 documentation files)
   - All committed and pushed

2. **"The main tool is ready: `process_experimental_data.py`"**
   - Will process your combined_density_matrix.csv
   - Outputs spatial average and L_diff
   - Generates plots

3. **"But I couldn't find the CSV file you mentioned"**
   - Need exact filename and location
   - Or can you share the data directly?

4. **"Once we have the data, just run one command"**
   - `python3 process_experimental_data.py`
   - Will give you exact values to plug into model

---

## Quick Command Reference for Next Session

```bash
# If file appears or user provides name:
python3 process_experimental_data.py

# If user wants to use known average value directly:
# Edit run_with_fixed_H.py line 39 with their value
python3 run_with_fixed_H.py

# If user wants to see current experimental targets:
cat EXPERIMENTAL_TARGETS.md

# To find any data files:
find . -type f \( -name "*.csv" -o -name "*.dat" -o -name "*.txt" \) | grep -i density
```

---

## Summary

**Created**: Complete toolkit for using experimental profiles ✓
**Documented**: 4 different approaches with pros/cons ✓
**Committed**: All changes pushed to branch ✓
**Blocked on**: Finding user's `combined_density_matrix.csv` file ⚠️

**Next action**: Locate the experimental data file and process it!

---

*End of memo. Session can resume from here.*
